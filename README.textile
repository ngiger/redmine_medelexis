h1. redmine_medelexis

Build status on tracis-ci: !https://travis-ci.org/ngiger/redmine_medelexis.svg?branch=master!:https://travis-ci.org/ngiger/redmine_medelexis

A few goodies for the Medelexis MIS

* admin-users see the api_key of all users
* hooks are called after create/editing service tickets

h2. TODO

* Scripts for the hooks

h2. installation

bc. cd /path/to/redmine/plugins
git clone git@github.com:ngiger/redmine_medelexis.github
service restart redmine
[09:51:04] Marco Descher: FÃ¼r Admin user https://mis.foo.org/mustermann/license.xml
[09:52:15] Marco Descher:  https://mis.foo.org/my/license - list of all service tickets
[09:52:23] Marco Descher:  https://mis.foo.org/my/license.xml - encrypted and signed license
[09:52:35] Marco Descher: https://mis.foo.org/mustermann/license - list of all service tickets
[09:52:42] Marco Descher: https://mis.foo.org/mustermann/license.xml -encrypted and signed license
Im logger IP-Adresse des Aufrufes abspeichern.

h2. configuration

Under http://foo.org/settings/plugin/redmine_medelexis you can add more debugging (to the default system logger) and to keep the temporary license files.

h2. Installation from scratch for development

Get the needed zip files. Used versions are found under https://mis.foo.org/admin/info
* rails-3.2.17
* redmine-2.4.5.zip
* redmine_contacts-3_2_13-pro.zip
* redmine_contacts_helpdesk-2.2.9-pro.zip
* redmine_contacts_invoices-3.2.3.zip
* redmine_products-1_0_3-pro.zip

Afterwards execute and verify these steps (assuming a bash shell). Using ruby 1.9.3p547 was fine for me. Ruby 2.1.2 had some problems

bc. unzip redmine-*.zip
export RAILS_ENV=development
cd redmine-2.4.2
cd plugins
unzip redmine_contacts-*-pro.zip
unzip redmine_contacts_helpdesk-*.zip
unzip redmine_contacts_invoices-*.zip
unzip redmine_products-*.zip
# (Skip unless production) git clone https://github.com/thorin/redmine_ldap_sync
git clone git@github.com:ngiger/redmine_medelexis.git # or https://github.com/ngiger/redmine_medelexis.git
git clone git@github.com:paginagmbh/redmine_silencer.git
cd ..
bundle install
bundle exec rake db:migrate RAILS_ENV=development
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_contacts
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_contacts_helpdesk
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_contacts_invoices
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_products
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_questions
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_silencer
# bundle exec rake redmine:plugins NAME=redmine_ldap_sync
bundle exec rake redmine:plugins RAILS_ENV=development NAME=redmine_medelexis


h2. development: Loading a dump

# remove color (twice in deal_statuses ), remove auth_sources from data.yml
# remove color, crea


@bundle exec rake RAILS_ENV=development db:data:load@ # loads db/data.yml

Afterwards you may examine the data as following

bc. set -x RAILS_ENV development; bundle exec rails console ; bundle exec rails console
Project.all.first

h2. Creating a dump from the production server

@bundle exec rake RAILS_ENV=production db:data:dump@ # creates db/data.yml

h2. Reset admin login, password and skip ldap

bc.  set -x RAILS_ENV development; bundle exec script/rails runner "user = User.find(:first, :conditions => {:admin => true, :name => 'admin'}) ; \
-user.auth_source_id = nil; user.password, user.password_confirmation = 'my_password'; user.save!"


If you know the login of you might also use something like @:conditions => {:login => "myLogin"}@

h2. Start rails for development

@set -x RAILS_ENV development; bundle exec ruby script/rails server webrick --port=30001@

h2. Running the tests

Now you should be able to login under
To run the tests, you must rake all plugins (as above) with RAILS_ENV=test. Then you may use calls like
* @bundle exec rake RAILS_ENV=test redmine:plugins:test NAME=redmine_medelexis@, which runs the test for all installed plugins.

Prepare for running tests (assuming a bash shell) for redmine_medelexis-plugins using

bc. set -x RAILS_ENV test
bundle exec rake db:migrate RAILS_ENV=test
bundle exec rake redmine:plugins RAILS_ENV=test NAME=redmine_contacts
bundle exec rake redmine:plugins RAILS_ENV=test NAME=redmine_contacts_helpdesk
bundle exec rake redmine:plugins RAILS_ENV=test NAME=redmine_products
bundle exec rake redmine:plugins RAILS_ENV=test NAME=redmine_contacts_invoices
bundle exec rake redmine:plugins RAILS_ENV=test NAME=redmine_questions
bundle exec rake redmine:plugins RAILS_ENV=test NAME=redmine_silencer

Run tests

* @set -x RAILS_ENV test; bundle exec rake redmine:plugins:test RAILS_ENV=test NAME=redmine_medelexis@ # runs all tests
* @set -x RAILS_ENV test; bundle exec ruby script/rails runner plugins/redmine_medelexis/test/functional/license_test.rb@ # runs a single test

h2. Scripts for the production server

h3. convert_test_abo_to_orders

The script scripts/convert_test_abo_to_orders.rb converts all open 'TRIAL' issues older than 1 month into 'LICENSED'. It should be run daily with a cron scripts. E.g. @/etc/cron.daily/onvert_test_abo_to_orders.sh@ could have the following content.

bc. #!/bin/bash
cd /path/to/redmine/checkout && bundle exec ruby script/rails runner plugins/redmine_medelexis/scripts/convert_test_abo_to_orders.rb

It will add the log entries like this to the system log

bc. Aug 11 20:28:11 host user: redmine_medelexis: issue_to_licensed took 1 second for ids 20,21,22

It bundles all changes into a single transaction which includes the system log output, therefore we should be able to trust it.

h3. create_invoices (alpha)

The script scripts/create_invoices.rb creates 6 (test) invoices using the last day of this year.

bc. bundle exec ruby script/rails runner plugins/redmine_medelexis/scripts/create_invoices.rb

h2. Using docker

See "doc":https://github.com/docker-library/docs/tree/master/redmine and "code":https://github.com/docker-library/redmine. Has no so old redmine. There adapted its Dockerfile.template.

bc. docker build -t ngiger/redmine .
docker run --detached -p 3000:3000 --env REDMINE_NO_DB_MIGRATE=1 -v /opt/src/redmine-medelexis/data2:/usr/src/redmine/files ngiger/redmine

# -name some-postgres -e POSTGRES_PASSWORD=secret -e POSTGRES_USER=redmine postgres

Status MIS-Beta 21.11.2015
Redmine plugins:
  redmine_access_filters         0.0.1
  redmine_contacts               3.4.4
  redmine_contacts_helpdesk      2.2.9-pro
  redmine_contacts_invoices      3.2.3
  redmine_issue_checklist        2.0.5
  redmine_medelexis              0.2.1
  redmine_products               1.0.3
-rw-r--r-- 1 niklaus niklaus 539214 Mai  8  2015 redmine_contacts-3_4_4-pro.zip
-rw-r--r-- 1 niklaus niklaus 248102 Mai  8  2015 redmine_contacts_helpdesk-2_3_0-pro.zip
-rw-r--r-- 1 niklaus niklaus 541841 Mai  8  2015 redmine_contacts_invoices-3_2_3-pro.zip
-rw-r--r-- 1 niklaus niklaus  26050 Mai  8  2015 redmine_issue_checklist-2_0_5.zip
-rw-r--r-- 1 niklaus niklaus 154308 Mai  8  2015 redmine_products-1_0_3-pro.zip
-rw-r--r-- 1 niklaus niklaus  49999 Mai  8  2015 redmine_questions-0_0_5-light.zip
n
